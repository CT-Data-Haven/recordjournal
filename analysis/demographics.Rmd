---
title: "Respondent demographics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(tidyverse)
library(cwi)
library(janitor)
library(camiller)
source("../utils/plot_utils.R")

#Cannot just re-run this! some denoms are hard-coded for non-response, and there's some text mining
```


```{r}
path <- "../survey_data/11082022/"
plot_path <- "../distro/"
```

```{r}
read_english <- read_csv(paste(path, "(English) RJ Latino Communities Reporting Lab Survey.csv", sep = "")) %>% 
  clean_names()

read_spanish <- read_csv(paste(path, "(Spanish) RJ Latino Communities Reporting Lab Survey.csv", sep = "")) %>% 
  clean_names()

qhead_eng <- tibble(question = paste("Q", 1:32, sep = ""),
                    label = colnames(read_english))
qhead_spn <- tibble(question = paste("Q", 1:32, sep = ""),
                    label = colnames(read_spanish))

colnames(read_english) <- qhead_eng$question
colnames(read_spanish) <- qhead_eng$question

read_english <- read_english %>% select(-Q29, -Q30, -Q31) %>% remove_empty("rows")
read_spanish <- read_spanish %>% select(-Q29, -Q30, -Q31) %>% remove_empty("rows")
```

```{r}
read_english_pr <- read_csv("../survey_data/08302022/(English - PR) RJ Latino Communities Reporting Lab Survey 2 2.csv") %>% 
  clean_names() %>% 
  mutate(`are_you_interested_in_news_at_the_following_geographical_levels_select_all_that_apply` = NA,
         `which_of_these_topics_interest_you_most_select_up_to_five` = NA,
         `do_any_of_these_special_stories_interest_you_select_all_that_apply` = NA,
         `are_there_any_specific_stories_you_would_like_to_see_more_of_in_local_news_for_example_investigative_articles_business_profiles_opinion_columns_cartoons_etc` = NA) %>% 
  select(timestamp, `are_you_interested_in_news_at_the_following_geographical_levels_select_all_that_apply`, `which_of_these_topics_interest_you_most_select_up_to_five`, `do_any_of_these_special_stories_interest_you_select_all_that_apply`, `are_there_any_specific_stories_you_would_like_to_see_more_of_in_local_news_for_example_investigative_articles_business_profiles_opinion_columns_cartoons_etc`, everything())

read_spanish_pr <- read_csv("../survey_data/08302022/(Spanish - PR) RJ Latino Communities Reporting Lab Survey (Responses) - Form Responses.csv") %>% 
  clean_names()

qhead_eng_pr <- tibble(question = paste("Q", 1:29, sep = ""),
                    label = colnames(read_english_pr))
qhead_spn_pr <- tibble(question = paste("Q", 1:29, sep = ""),
                    label = colnames(read_spanish_pr))

colnames(read_english_pr) <- qhead_spn_pr$question
colnames(read_spanish_pr) <- qhead_spn_pr$question

read_english_pr <- read_english_pr %>% remove_empty("rows")
read_spanish_pr <- read_spanish_pr %>% remove_empty("rows")

read_english <- read_english %>% bind_rows(read_english_pr) %>% rename(id = Q1)
read_spanish <- read_spanish %>% bind_rows(read_spanish_pr) %>% rename(id = Q1)
```

```{r}
age <- tibble(id = read_english$id,
              age = as.factor(read_english$Q22),
              survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   age = as.factor(read_spanish$Q22),
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(age)) %>% 
  mutate(age = if_else(age == "70 o mayor", "70 or older", as.character(age)),
         age = if_else(age == "Menor de 18", "Under 18", age)) %>% 
  filter(!age %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(age = as.factor(age),
         age = fct_relevel(age, "Under 18", after = 0L)) %>% 
  mutate(age = fct_collapse(age, age00_29 = c("Under 18", "18-29"), age30_49 = c("30-39", "40-49"),  age50_99 = c("50-59", "60-69", "70 or older")))
```

Current number of respondents (blanks removed) as of November 8, 2022.

**I'm going to stop disaggregating by survey type so we can focus on disaggregating by other metrics, like age, gender, or nationality**

```{r}
###HARD CODED DENOM
responses <- tibble(survey = c("English", "Spanish"),
                    responses = c(count(read_english), count(read_spanish))) %>% 
  mutate(responses = as.integer(responses)) %>% 
  add_row(survey = "Total", responses = 1648)

responses %>% knitr::kable()
```

# Demographics

### Age

```{r}
response_age <- response_town <- tibble(age = as.factor(read_english$Q22),
                        survey = as.factor("English")) %>% 
  bind_rows(tibble(age = as.factor(read_spanish$Q22),
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(age)) %>% 
  mutate(age = if_else(age == "70 o mayor", "70 or older", as.character(age)),
         age = if_else(age == "Menor de 18", "Under 18", age)) %>% 
  filter(!age %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(age = as.factor(age),
         age = fct_relevel(age, "Under 18", after = 0L)) %>% 
  select(-survey) %>% 
  group_by(age) %>% 
  count()
```

This time around, I'll group ages into 0-29, 30-49, and 50+

```{r}
response_age %>% 
  ggplot(aes(x = age, y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 1.2) +
  labs(title = "Respondents by age", x = NULL, y = NULL) +
  theme(axis.text.y = element_blank())
```

### Gender x age

```{r}
response_gender <- tibble(id = read_english$id,
                          gender = read_english$Q23,
                          survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   gender = read_spanish$Q23,
                   survey = as.factor("Spanish"))) %>% 
   mutate(gender = if_else(gender == "Hombre", "Man", gender),
          gender = if_else(gender == "Mujer", "Woman", gender),
          gender = if_else(grepl("Non-binary", gender), "Transgender & NB", gender),
          gender = if_else(gender %in% c("Transgénero", "Transgender"), "Transgender & NB", gender)) %>% 
  filter(!gender %in% c("Prefiero no decir", "Prefer not to say"), !is.na(gender)) %>% 
  mutate(gender = as.factor(gender) %>% fct_relevel(., "Woman", "Man", "Transgender & NB")) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-id, -survey) %>% 
  filter(!is.na(age)) %>% 
  group_by(age, gender) %>% 
  count() %>% 
  ungroup()
```

Across all age groups, more women than men responding, with greatest disparity in 30-49 range. Keep that in mind as we look at these age-based breakdowns later.

```{r}
response_gender %>% 
  ggplot(aes(x = age, y = n, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = n), position = position_dodge(.9), vjust = -.2, color = "grey20") +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow", "red")])) +
  theme(legend.position = "bottom",
        axis.text.y = element_blank()) +
  labs(x = NULL, y = NULL, title = "Respondents by gender and age")
```

### Town of residence

Someone asked to show the top 5 towns

```{r}
response_town <- tibble(town = read_english$Q19,
                        survey = as.factor("English")) %>% 
  bind_rows(tibble(town = read_spanish$Q19,
                   survey = as.factor("Spanish"))) %>% 
  mutate(town = str_to_title(town)) %>% 
  filter(!is.na(town)) %>% 
  select(-survey) %>% 
  mutate(town = if_else(!town %in% c("Meriden", "Wallingford", "New Haven", "Waterbury", "Hartford"), "All others", town)) %>% 
  group_by(town) %>% 
  count() %>% 
  ungroup()
```

```{r}
response_town %>% 
  ggplot(aes(x = n, y = reorder(town, n))) +
  geom_col() +
  geom_text(aes(label = n), hjust = 1.2) +
  labs(title = "Respondents by town of residence (top 5 towns shown)", x = NULL, y = NULL) +
  theme(axis.text.x = element_blank())
```

### Ethnicity x gender x age

```{r}
##HARD CODED DENOMS
response_latino <- tibble(id = read_english$id,
                          latino = read_english$Q20,
                          gender = read_english$Q23) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   latino = read_spanish$Q20,
                   gender = read_spanish$Q23)) %>% 
  filter(!is.na(latino), !latino %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(latino = if_else(latino == "Sí", "Yes", latino)) %>% 
  mutate(gender = if_else(gender == "Hombre", "Man", gender),
          gender = if_else(gender == "Mujer", "Woman", gender),
          gender = if_else(grepl("Non-binary", gender), "Transgender & NB", gender),
          gender = if_else(gender %in% c("Transgénero", "Transgender"), "Transgender & NB", gender)) %>% 
  filter(!gender %in% c("Prefiero no decir", "Prefer not to say"), !is.na(gender)) %>% 
  left_join(age, by = c("id")) %>% 
  filter(!is.na(age)) %>% 
  group_by(age, gender, latino) %>% 
  count() %>% 
  ungroup() %>% 
  add_row(age = "age00_29", gender = "Woman", latino = "Total", n = 155) %>% 
  add_row(age = "age00_29", gender = "Man", latino = "Total", n = 109) %>% 
  add_row(age = "age00_29", gender = "Transgender & NB", latino = "Total", n = 5) %>% 
  add_row(age = "age30_49", gender = "Woman", latino = "Total", n = 467) %>% 
  add_row(age = "age30_49", gender = "Man", latino = "Total", n = 269) %>% 
  add_row(age = "age30_49", gender = "Transgender & NB", latino = "Total", n = 2) %>% 
  add_row(age = "age50_99", gender = "Woman", latino = "Total", n = 317) %>%
  add_row(age = "age50_99", gender = "Man", latino = "Total", n = 239) %>%
    mutate(gender = as.factor(gender) %>% fct_relevel(., "Woman", "Man", "Transgender & NB")) %>% 
  group_by(age, gender) %>% 
  calc_shares(group = latino, denom = "Total", value = n)
```

Slightly lower shares identifying as Latino in older populations

```{r}
response_latino %>% 
  filter(!is.na(share), latino == "Yes", gender != "Transgender & NB") %>% 
  ggplot(aes(x = age, y = share, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), vjust = 1.2) +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow")])) +
  labs(title = "Share of respondents who identify as Latino/Latina/Latinx", x = NULL, y = NULL, caption = "Transgender & NB dropped due to low counts (7 total)") +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom")
```

### Place of birth

```{r}
response_birthplace <- tibble(place = read_english$Q21,
                              survey = as.factor("English")) %>% 
  bind_rows(tibble(place = read_spanish$Q21,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(place), place != "No") %>% 
  mutate(clean = str_to_upper(place)) %>% 
  mutate(clean = if_else(grepl("PUER|P.R|PR", clean), "PUERTO RICO", clean),
         clean = if_else(grepl("AMERICA|MERIDEN|US|USA|UNITED|U.S|CT|NEW YORK|EEUU|ESTADO|COUNTY|CHICAGO|CALIFORNIA|NEW HAVEN", clean), "USA", clean),
         clean = if_else(grepl("REPUB", clean), "DOMINICAN REPUBLIC", clean),
         clean = if_else(grepl("MEX|GUANA", clean), "MEXICO", clean),
         clean = if_else(grepl("ECUADOR", clean), "ECUADOR", clean)) %>% 
  mutate(clean = if_else(!clean %in% c("USA", "PUERTO RICO", "DOMINICAN REPUBLIC", "ECUADOR", "MEXICO"), "OTHER", clean)) %>% 
  mutate(clean = as.factor(clean),
         clean = fct_relevel(clean, "OTHER", after = Inf)) %>% 
  select(-place) %>% 
  tabyl(clean, survey) %>% 
  adorn_totals("row") %>% 
  pivot_longer(cols = English:Spanish, names_to = "survey", values_to = "value") %>% 
  group_by(survey) %>% 
  calc_shares(group = clean, denom = "Total", value = value)
```

```{r}
response_birthplace %>% 
  filter(!clean == "Total") %>% 
  mutate(clean = str_to_title(clean)) %>% 
  ggplot(aes(x = share, y = reorder(clean, share))) +
  geom_col() +
  geom_text(data = . %>% filter(share >.08), aes(label = scales::percent(share, accuracy = 1)), hjust = 1.1, size =4) +
  geom_text(data = . %>% filter(share <=.08), aes(label = scales::percent(share, accuracy = 1)), hjust = -.1, color = "black", size =4) +
  facet_grid(cols = vars(survey)) +
  labs(title = "Respondents by birthplace", x = NULL, y = NULL) +
  theme(axis.text.x = element_blank())
```

### Language spoken at home

```{r}
response_lang_at_home <- tibble(lang = read_english$Q24,
                              survey = as.factor("English")) %>% 
  bind_rows(tibble(lang = read_spanish$Q24,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(lang)) %>% 
  mutate(lang = if_else(grepl("Ambos|Spanglish", lang), "Both English and Spanish", lang),
         lang = if_else(lang == "Español", "Spanish", lang),
         lang = if_else(!lang %in% c("English", "Spanish", "Both English and Spanish"), "Other", lang)) %>% 
  mutate(lang = as.factor(lang),
         lang = fct_relevel(lang, "English", "Both English and Spanish", "Spanish", "Other")) %>% 
  tabyl(lang, survey) %>% 
  adorn_totals("row") %>% 
  pivot_longer(cols = English:Spanish, names_to = "survey", values_to = "value") %>% 
  group_by(survey) %>% 
  calc_shares(group = lang, denom = "Total", value = value)
```

```{r}
response_lang_at_home %>% 
  filter(!is.na(share)) %>% 
  ggplot(aes(x = lang, y = share, group = survey)) +
  geom_col(position = position_dodge()) +
  geom_text(data = . %>% filter(share >.1), aes(label = scales::percent(share, accuracy = 1)), vjust = 1.1, size =4) +
  geom_text(data = . %>% filter(share <=.1), aes(label = scales::percent(share, accuracy = 1)), vjust = -.1, color = "black", size =4) +
  facet_grid(rows = vars(survey), switch = "y") +
  labs(title = "Respondents by language spoken at home", x = NULL, y = NULL) +
  theme(axis.text.y.left = element_blank())
```

### Internet-enabled devices and internet at home

```{r}
response_web_at_home <- tibble(internet = read_english$Q27,
                           survey = as.factor("English")) %>% 
  bind_rows(tibble(internet = read_spanish$Q27,
                   survey = as.factor("Spanish"))) %>% 
  filter(!internet %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(internet = fct_collapse(internet, Yes = c("Yes", "Sí"))) %>% 
  filter(!is.na(internet)) %>% 
  tabyl(internet, survey) %>% 
  adorn_totals("row") %>% 
  pivot_longer(cols = English:Spanish, names_to = "survey", values_to = "value") %>% 
  group_by(survey) %>% 
  calc_shares(group = internet, denom = "Total", value = value)
```

```{r}
response_web_at_home %>%
  filter(!is.na(share)) %>% 
  mutate(share = scales::percent(share, accuracy = 1)) %>%
  select(-value) %>% 
  pivot_wider(id_cols = internet, names_from = survey, values_from = share) %>% 
  knitr::kable()
```

```{r}
response_device_age <- tibble(device = read_english$Q26,
                          age = as.factor(read_english$Q22),
                          survey = as.factor("English")) %>% 
  bind_rows(tibble(device = read_spanish$Q26,
                   age = as.factor(read_spanish$Q22),
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(device), device != "Prefer not to say") %>% 
  mutate(device = as.factor(device),
         device = fct_collapse(device, Yes = c("Yes", "Sí"))) %>% 
  filter(!is.na(age)) %>% 
  mutate(age = if_else(age == "70 o mayor", "70 or older", as.character(age)),
         age = if_else(age == "Menor de 18", "Under 18", age)) %>% 
  filter(!age %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(age = as.factor(age),
         age = fct_relevel(age, "Under 18", after = 0L)) %>% 
  mutate(age = fct_collapse(age, under_40 = c("Under 18", "18-29", "30-39"), over_40 = c("40-49", "50-59", "60-69", "70 or older"))) %>% 
  group_by(device, age, survey) %>% 
  count() %>% 
  ungroup() %>%
  group_by(survey, age) %>% 
  mutate(total = sum(n)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(share = n / total)
```


```{r}
response_device_age %>%
  filter(device == "No") %>% 
  ggplot(aes(x = age, y = share)) +
  geom_col() +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), vjust = 1.2, size = 4) +
  facet_grid(cols = vars(survey)) +
  labs(title = "No internet-enabled device, by age group and survey", y = NULL) +
  theme(axis.text.y = element_blank())
```

### Registered voter

```{r}
response_voter <- tibble(registered = as.factor(read_english$Q28),
       survey = as.factor("English")) %>% 
  bind_rows(tibble(registered = as.factor(read_spanish$Q28),
                   survey = as.factor("Spanish"))) %>% 
   filter(!is.na(registered)) %>% 
  mutate(registered = fct_collapse(registered, Yes = c("Yes", "Sí"), `Not sure/Prefer not to say` = c("Prefer not to say", "Prefiero no decir", "Not sure", "No estoy seguro/a"))) %>% 
  tabyl(registered, survey) %>% 
  adorn_totals("row") %>% 
  pivot_longer(cols = English:Spanish, names_to = "survey", values_to = "value") %>% 
  group_by(survey) %>% 
  calc_shares(group = registered, denom = "Total", value = value)
```

```{r}
response_voter %>% 
  filter(!is.na(share)) %>% 
  mutate(share = scales::percent(share, accuracy = 1)) %>% 
  pivot_wider(id_cols = registered, names_from = survey, values_from = share) %>% 
  knitr::kable()
```

### Other demographic details

```{r}
response_details <- tibble(indicator = read_english$Q25,
                           survey = as.factor("English")) %>% 
  bind_rows(tibble(indicator = read_spanish$Q25,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(indicator)) %>% 
  mutate(indicator = if_else(grepl("stu", indicator), "Student", indicator),
         indicator = if_else(grepl("18", indicator), "Parent", indicator),
         indicator = if_else(grepl("business|empresa", indicator), "Business owner", indicator),
         indicator = if_else(grepl("None|Ninguno", indicator), "None of these", indicator)) %>% 
  mutate(indicator = as.factor(indicator),
         indicator = fct_relevel(indicator, "None of these", after = Inf)) %>% 
  tabyl(indicator, survey) %>% 
  adorn_totals("row") %>% 
  pivot_longer(cols = English:Spanish, names_to = "survey", values_to = "value") %>% 
  group_by(survey) %>% 
  calc_shares(group = indicator, denom = "Total", value = value)
```

```{r}
response_details %>% 
  filter(!indicator %in% c("Total", "None of these")) %>% 
  ggplot(aes(x = share, y = fct_rev(indicator))) +
  geom_col() +
  geom_text(data = . %>% filter(share >.08), aes(label = scales::percent(share, accuracy = 1)), hjust = 1.1, size =4) +
  geom_text(data = . %>% filter(share <=.08), aes(label = scales::percent(share, accuracy = 1)), hjust = -.1, color = "black", size =4) +
  facet_grid(cols = vars(survey)) +
  labs(title = "Respondents by demographic detail", x = NULL, y = NULL) +
  theme(axis.text.x = element_blank())
```


