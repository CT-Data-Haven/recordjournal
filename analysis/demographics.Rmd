---
title: "Respondent demographics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r libraries}
library(tidyverse)
library(cwi)
library(janitor)
library(camiller)
source("../utils/plot_utils.R")

#Cannot just re-run this! some denoms are hard-coded for non-response, and there's some text mining
```


```{r paths}
path <- "../survey_data/11082022/"
plot_path <- "../distro/"
read <- read_csv(paste(path, "clean.csv"))
```

Current number of respondents (blanks removed) as of November 8, 2022.

```{r count}
read %>% 
  select(survey) %>% 
  group_by(survey) %>% 
  count() %>% 
  adorn_totals() %>% 
  knitr::kable()
```


**I'm going to stop disaggregating by survey type so we can focus on disaggregating by other metrics, like age, gender, or nationality**

## Age

```{r age}
age <- read %>%
  select(small_age_band) %>% 
  group_by(small_age_band) %>%
  count() %>% 
  ungroup() %>% 
  mutate(small_age_band = as.factor(small_age_band) %>% 
           fct_relevel(., "Under 18"))

age %>%
  filter(!is.na(small_age_band)) %>% 
  ggplot(aes(x = small_age_band, y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 1.2) +
  labs(title = "Respondents by age", x = NULL, y = NULL) +
  theme(axis.text.y = element_blank())
```

This time around, I'll group ages into 0-29, 30-49, and 50+

## Gender x age

Across all age groups, more women than men responding, with greatest disparity in 30-49 range. Keep that in mind as we look at these age-based breakdowns later.

**Also we are now HEAVILY skewed towards middle-aged women**

```{r gender}
read %>%
  select(gender) %>% 
  group_by(gender) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  knitr::kable()

gender <- read %>% 
  select(gender, big_age_band) %>% 
  group_by(big_age_band, gender) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(gender = as.factor(gender) %>% 
           fct_relevel(., "Woman", "Man", "Transgender & NB"))

gender %>% 
  filter(!is.na(gender), !is.na(big_age_band), gender != "Opt out") %>% 
  ggplot(aes(x = big_age_band, y = n, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = n), position = position_dodge(.9), vjust = -.2, color = "grey20") +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow", "red")])) +
  theme(legend.position = "bottom",
        axis.text.y = element_blank()) +
  labs(x = NULL, y = NULL, title = "Respondents by gender and age")
```

## Town of residence

Someone asked to see the top 5 towns

```{r}
town <- read %>%
  select(residence_town) %>% 
  group_by(residence_town) %>% 
  count()
  
town %>% 
  ggplot(aes(x = n, y = reorder(residence_town, n))) +
  geom_col() +
  geom_text(aes(label = n), hjust = 1.2) +
  labs(title = "Respondents by town of residence", subtitle = "Only top 5 towns shown", x = NULL, y = NULL) +
  theme(axis.text.x = element_blank())
```

## Ethnicity x gender x age

Slightly lower shares of older adults identifying as Latino

```{r ethnicity}
gender_age_totals <- read %>% 
  select(gender, age = big_age_band) %>% 
  group_by(gender, age) %>% 
  count()

ethnicity <- read %>% 
  select(latino, gender, age = big_age_band) %>% 
  group_by(latino, gender, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(gender_age_totals %>% mutate(latino = "Total")) %>% 
  group_by(age, gender) %>% 
  calc_shares(group = latino, denom = "Total", value = n) %>% 
  ungroup()

read %>% 
  select(latino) %>% 
  group_by(latino) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  knitr::kable()

ethnicity %>% 
  filter(!is.na(share), latino == "Yes", !is.na(gender), !gender %in% c("Transgender & NB", "Opt out"), !is.na(age)) %>% 
  ggplot(aes(x = age, y = share, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), vjust = 1.2) +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow")])) +
  labs(title = "Share of respondents who identify as Latino/Latina/Latinx", x = NULL, y = NULL, caption = "Transgender & NB dropped due to low counts n < 10") +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom")
```

## Place of birth x age

```{r eval = F}
response_birthplace <- tibble(id = read_english$id,
                              place = read_english$Q21,
                              survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   place = read_spanish$Q21,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(place), place != "No") %>% 
  mutate(clean = str_to_upper(place)) %>% 
  mutate(clean = if_else(grepl("PUER|P.R|PR", clean), "PUERTO RICO", clean),
         clean = if_else(grepl("AMERICA|MERIDEN|US|USA|UNITED|U.S|CT|NEW YORK|EEUU|ESTADO|COUNTY|CHICAGO|CALIFORNIA|NEW HAVEN", clean), "USA", clean),
         clean = if_else(grepl("REPUB|DR", clean), "DOMINICAN REPUBLIC", clean),
         clean = if_else(grepl("MEX|GUANA", clean), "MEXICO", clean),
         clean = if_else(grepl("ECUADOR", clean), "ECUADOR", clean)) %>% 
  mutate(clean = if_else(!clean %in% c("USA", "PUERTO RICO", "DOMINICAN REPUBLIC", "ECUADOR", "MEXICO"), "OTHER", clean)) %>% 
  mutate(clean = as.factor(clean),
         clean = fct_relevel(clean, "USA", "PUERTO RICO", "ECUADOR", "MEXICO", "DOMINICAN REPUBLIC", "OTHER")) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-place, -survey, -id) %>% 
  group_by(age, clean) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

pobtot <- response_birthplace %>% 
  mutate(clean = "TOTAL") %>% 
  group_by(age, clean) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_birthplace <- response_birthplace %>% 
  bind_rows(pobtot) %>% 
  group_by(age) %>% 
  calc_shares(group = clean, denom = "TOTAL", value = n)
```

```{r eval = F}
response_birthplace %>% 
  mutate(age = fct_rev(age),
         clean = fct_rev(clean)) %>% 
  ggplot(aes(x = share, y = age, group = clean)) +
  geom_col(aes(fill = clean), width = .8, position = position_stack(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_stack(.5)) +
  guides(fill = guide_legend(title = "Place of birth", reverse = T)) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank()) +
  scale_fill_manual(values = unname(qual_pal[c("pink", "yellow", "teal", "cyan", "violet", "gray")])) +
  labs(x = NULL, y = NULL, title = "Respondents by age and place of birth",
       caption = "PR and USA may not be mutually exclusive")
```

## Language spoken at home x age

```{r eval = F}
response_lang_at_home <- tibble(id = read_english$id, 
                                lang = read_english$Q24,
                              survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id, 
                   lang = read_spanish$Q24,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(lang)) %>% 
  mutate(lang = if_else(grepl("Ambos|Spanglish", lang), "Both English and Spanish", lang),
         lang = if_else(lang == "Español", "Spanish", lang),
         lang = if_else(!lang %in% c("English", "Spanish", "Both English and Spanish"), "Other", lang)) %>% 
  mutate(lang = as.factor(lang),
         lang = fct_relevel(lang, "English", "Both English and Spanish", "Spanish", "Other")) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-survey, -id) %>% 
  group_by(age, lang) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

langtot <- response_lang_at_home %>% 
  mutate(lang = "Total") %>% 
  group_by(age, lang) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_lang_at_home <- response_lang_at_home %>% 
  bind_rows(langtot) %>% 
  group_by(age) %>% 
  calc_shares(group = lang, denom = "Total", value = n)
```

```{r eval = F}
response_lang_at_home %>% 
   mutate(age = fct_rev(age),
         lang = fct_rev(lang)) %>% 
  ggplot(aes(x = share, y = age, group = lang)) +
  geom_col(aes(fill = lang), width = .8, position = position_stack(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_stack(.5)) +
  guides(fill = guide_legend(title = "Language", reverse = T)) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank()) +
  scale_fill_manual(values = unname(qual_pal[c("red", "cyan", "violet", "yellow")])) +
  labs(x = NULL, y = NULL, title = "Respondents by age and language spoken at home")
```

## Internet-enabled devices and internet at home x age

```{r eval = F}
response_web_at_home <- tibble(id = read_english$id,
                               internet = read_english$Q27,
                           survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   internet = read_spanish$Q27,
                   survey = as.factor("Spanish"))) %>% 
  filter(!internet %in% c("Prefiero no decir", "Prefer not to say")) %>% 
  mutate(internet = fct_collapse(internet, Yes = c("Yes", "Sí"))) %>% 
  filter(!is.na(internet)) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-survey, -id) %>% 
  group_by(age, internet) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

inttot <- response_web_at_home %>% 
  mutate(internet = "Total") %>% 
  group_by(age, internet) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_web_at_home <- response_web_at_home %>% 
  bind_rows(inttot) %>% 
  group_by(age) %>% 
  calc_shares(group = internet, denom = "Total", value = n)
```

```{r eval = F}
response_web_at_home %>%
  filter(internet == "No") %>% 
  ggplot(aes(x = age, y = share)) +
  geom_col(width = .5) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), vjust = 1.2) +
  labs(x = NULL, y = NULL, title = "Respondents without internet at home, by age") +
  theme(axis.text.y = element_blank())
```

```{r eval = F}
response_device <- tibble(id = read_english$id,
                              device = read_english$Q26,
                              survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   device = read_spanish$Q26,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(device), device != "Prefer not to say") %>% 
  mutate(device = as.factor(device),
         device = fct_collapse(device, Yes = c("Yes", "Sí"))) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-survey, -id) %>% 
  group_by(age, device) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

devtot <- response_device %>% 
  mutate(device = "Total") %>% 
  group_by(age, device) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_device <- response_device %>% 
  bind_rows(devtot) %>% 
  group_by(age) %>% 
  calc_shares(group = device, denom = "Total", value = n)
```

```{r eval = F}
response_device %>%
  filter(device == "No") %>% 
  ggplot(aes(x = age, y = share)) +
  geom_col(width = .5) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), vjust = 1.2) +
  labs(x = NULL, y = NULL, title = "Respondents without internet-enabled devices, by age") +
  theme(axis.text.y = element_blank())
```

## Registered voter

```{r eval = F}
response_voter <- tibble(id = read_english$id,
                         registered = as.factor(read_english$Q28),
       survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   registered = as.factor(read_spanish$Q28),
                   survey = as.factor("Spanish"))) %>% 
   filter(!is.na(registered)) %>% 
  mutate(registered = fct_collapse(registered, Yes = c("Yes", "Sí"), `Not sure/Prefer not to say` = c("Prefer not to say", "Prefiero no decir", "Not sure", "No estoy seguro/a"))) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-survey, -id) %>% 
  group_by(age, registered) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

votetot <- response_voter %>% 
  mutate(registered = "Total") %>% 
  group_by(age, registered) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_voter <- response_voter %>% 
  bind_rows(votetot) %>% 
  group_by(age) %>% 
  calc_shares(group = registered, denom = "Total", value = n)
```

```{r eval = F}
response_voter %>% 
  filter(registered == "Yes") %>% 
  mutate(age = fct_rev(age)) %>% 
  ggplot(aes(x = share, y = age)) +
  geom_col() +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), hjust = 1.2) +
  labs(x = NULL, y = NULL, title = "Registered voters, by age") +
  theme(axis.text.x = element_blank())
```

## Other demographic details

```{r eval = F}
response_details <- tibble(id = read_english$id,
                           indicator = read_english$Q25,
                           survey = as.factor("English")) %>% 
  bind_rows(tibble(id = read_spanish$id,
                   indicator = read_spanish$Q25,
                   survey = as.factor("Spanish"))) %>% 
  filter(!is.na(indicator)) %>% 
  mutate(indicator = if_else(grepl("stu", indicator), "Student", indicator),
         indicator = if_else(grepl("18", indicator), "Parent", indicator),
         indicator = if_else(grepl("business|empresa", indicator), "Business owner", indicator),
         indicator = if_else(grepl("None|Ninguno", indicator), "None of these", indicator)) %>% 
  mutate(indicator = as.factor(indicator),
         indicator = fct_relevel(indicator, "None of these", after = Inf)) %>% 
  left_join(age, by = c("survey", "id")) %>% 
  select(-survey, -id) %>% 
  group_by(age, indicator) %>% 
  count() %>% 
  filter(!is.na(age)) %>% 
  ungroup()

typetot <- response_details %>% 
  mutate(indicator = "Total") %>% 
  group_by(age, indicator) %>% 
  summarise(n = sum(n)) %>% 
  ungroup()

response_details <- response_details %>% 
  bind_rows(typetot) %>% 
  group_by(age) %>% 
  calc_shares(group = indicator, denom = "Total", value = n)
```

```{r eval = F}
response_details %>% 
  filter(indicator != "Total") %>% 
  select(-age) %>% 
  group_by(indicator) %>% 
  summarise(n = sum(n))
```

```{r eval = F}
response_details %>%
  mutate(age = fct_rev(age)) %>% 
  mutate(indicator = fct_rev(indicator)) %>% 
  ggplot(aes(x = share, y = age, group = indicator)) +
  geom_col(aes(fill = indicator), position = position_stack(.9), width = .5) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_stack(.5)) +
  scale_fill_manual(values = unname(qual_pal[c("gray", "cyan", "violet", "yellow")])) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank()) +
  labs(title = "Select personal characteristics by age", x = NULL, y = NULL)
```


