---
title: "Respondent demographics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r libraries}
library(tidyverse)
library(cwi)
library(janitor)
library(camiller)
source("../utils/plot_utils.R")
```

```{r paths}
path <- "../survey_data/12272022/"
plot_path <- "../distro/"
read <- read_csv(paste(path, "clean.csv"))
```

Current number of respondents (blanks removed) as of November 8, 2022.

```{r count}
read %>% 
  select(survey) %>% 
  group_by(survey) %>% 
  count() %>% 
  adorn_totals() %>% 
  knitr::kable()
```

**I'm going to stop disaggregating by survey type so we can focus on disaggregating by other metrics, like age, gender, or nationality**

## Age

```{r age}
age <- read %>%
  select(small_age_band) %>% 
  group_by(small_age_band) %>%
  count() %>% 
  ungroup() %>% 
  mutate(small_age_band = as.factor(small_age_band) %>% 
           fct_relevel(., "Under 18"))

age %>%
  filter(!is.na(small_age_band)) %>% 
  ggplot(aes(x = small_age_band, y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 1.2) +
  labs(title = "Respondents by age", x = NULL, y = NULL) +
  theme(axis.text.y = element_blank())
```

This time around, I'll group ages into 0-29, 30-49, and 50+

## Gender x age

Across all age groups, more women than men responding, with greatest disparity in 30-49 range. Keep that in mind as we look at these age-based breakdowns later.

**Also we are now HEAVILY skewed towards middle-aged women**

```{r gender}
#read %>% select(gender) %>% filter(!is.na(gender)) %>% count()

read %>%
  select(gender) %>% 
  group_by(gender) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(share = n / 2033) %>% 
  mutate(share = scales::percent(share, accuracy = 1)) %>% 
  knitr::kable()

gender <- read %>% 
  select(gender, big_age_band) %>% 
  group_by(big_age_band, gender) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(gender = as.factor(gender) %>% 
           fct_relevel(., "Woman", "Man", "Transgender & NB"))

gender %>% 
  filter(!is.na(gender), !is.na(big_age_band), gender != "Opt out") %>% 
  ggplot(aes(x = big_age_band, y = n, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = n), position = position_dodge(.9), vjust = -.2, color = "grey20") +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow", "red")])) +
  theme(legend.position = "bottom",
        axis.text.y = element_blank()) +
  labs(x = NULL, y = NULL, title = "Respondents by gender and age")
```

## Town of residence

Someone asked to see the top 5 towns

```{r}
town <- read %>%
  select(residence_town) %>% 
  group_by(residence_town) %>% 
  count()
  
town %>% 
  ggplot(aes(x = n, y = reorder(residence_town, n))) +
  geom_col() +
  geom_text(aes(label = n), hjust = 1.2) +
  labs(title = "Respondents by town of residence", subtitle = "Only top 5 towns shown", x = NULL, y = NULL) +
  theme(axis.text.x = element_blank())
```

## Ethnicity x gender x age

Slightly lower shares of older adults identifying as Latino

```{r ethnicity}
gender_age_totals <- read %>% 
  select(gender, age = big_age_band) %>% 
  group_by(gender, age) %>% 
  count()

ethnicity <- read %>% 
  select(latino, gender, age = big_age_band) %>% 
  group_by(latino, gender, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(gender_age_totals %>% mutate(latino = "Total")) %>% 
  group_by(age, gender) %>% 
  calc_shares(group = latino, denom = "Total", value = n) %>% 
  ungroup()

ethnicity %>% 
  filter(!is.na(share), !is.na(age), latino == "Yes", !is.na(gender), !gender %in% c("Transgender & NB", "Opt out"), !is.na(age)) %>% 
  ggplot(aes(x = age, y = share, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), vjust = 1.2) +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow")])) +
  labs(title = "Share of respondents who identify as Latino/Latina/Latinx", x = NULL, y = NULL, caption = "Transgender & NB dropped due to low counts n < 10") +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom")
```

## Place of birth x age

Younger and older people more likely to be born in the US/PR. I am surprised at the diversity in the 30-49 crowd.

```{r pob}
age_totals <- read %>% 
  select(age = big_age_band) %>% 
  group_by(age) %>% 
  count()

#read %>% select(place_of_birth) %>% filter(!is.na(place_of_birth)) %>% count()

read %>% select(place_of_birth) %>% 
  group_by(place_of_birth) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(share = n / 2033) %>% 
  mutate(share = scales::percent(share, accuracy = 1)) %>% 
  knitr::kable()

pob <- read %>% 
  select(place_of_birth, age = big_age_band) %>% 
  group_by(place_of_birth, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(age_totals %>% mutate(place_of_birth = "Total")) %>% 
  group_by(age) %>% 
  calc_shares(group = place_of_birth, denom = "Total", value = n) %>% 
  ungroup()

pob %>%
  filter(!is.na(age)) %>% 
  mutate(age = as.factor(age) %>% fct_rev()) %>% 
  ggplot(aes(x = share, y = age, group = age)) +
  geom_col(aes(fill = place_of_birth), width = .8, position = position_stack(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_stack(.5)) +
  guides(fill = guide_legend(title = "Place of birth", reverse = T)) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank()) +
  scale_fill_manual(values = unname(qual_pal[c("pink", "yellow", "teal", "cyan", "violet", "gray")])) +
  labs(x = NULL, y = NULL, title = "Respondents by age and place of birth",
       caption = "PR and USA may not be mutually exclusive")
```

## Language spoken at home x age

Pretty even language split among older adults.

```{r lang_at_home}
lang_at_home <- read %>% 
  select(language, age = big_age_band) %>% 
  mutate(language = if_else(is.na(language), "Other", language)) %>% 
  group_by(age, language) %>%
  count() %>% 
  ungroup() %>% 
  bind_rows(age_totals %>% mutate(language = "Total")) %>% 
  group_by(age) %>% 
  calc_shares(group = language, denom = "Total", value = n) %>% 
  ungroup()

#read %>% select(language) %>% filter(!is.na(language)) %>% count()

read %>%
  select(language) %>% 
  filter(!is.na(language)) %>%
  group_by(language) %>% 
  count() %>% 
  mutate(share = n / 1961) %>% 
  mutate(share = scales::percent(share, accuracy = 1)) %>% 
  knitr::kable()

lang_at_home %>% 
  filter(!is.na(age)) %>% 
  mutate(age = as.factor(age) %>% fct_rev()) %>% 
  ggplot(aes(x = share, y = age, group = language)) +
  geom_col(aes(fill = language), width = .8, position = position_stack(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_stack(.5)) +
  guides(fill = guide_legend(title = "Language", reverse = T)) +
  theme(legend.position = "bottom",
        axis.text.x = element_blank()) +
  scale_fill_manual(values = unname(qual_pal[c("red", "cyan", "violet", "yellow")])) +
  labs(x = NULL, y = NULL, title = "Respondents by age and language spoken at home")
```

## Internet-enabled devices and internet at home x age

I'm kind of shocked at the under-30 lack of device/internet, but not at the notable increase in lack of internet in older age groups; lack of device corresponds with lack of internet.

```{r internet}
internet <- read %>%
  select(web_at_home, age = big_age_band) %>% 
  group_by(web_at_home, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(age_totals %>% mutate(web_at_home = "Total")) %>% 
  group_by(age) %>% 
  calc_shares(group = web_at_home, denom = "Total", value = n)

internet %>%
  filter(web_at_home == "No", !is.na(age)) %>% 
  ggplot(aes(x = age, y = share)) +
  geom_col(width = .5) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), vjust = 1.2) +
  labs(x = NULL, y = NULL, title = "Respondents without internet at home, by age") +
  theme(axis.text.y = element_blank())
```

```{r device}
device <- read %>%
  select(web_device, age = big_age_band) %>% 
  group_by(web_device, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(age_totals %>% mutate(web_device = "Total")) %>% 
  group_by(age) %>% 
  calc_shares(group = web_device, denom = "Total", value = n)

device %>%
  filter(web_device == "No", !is.na(age)) %>% 
  ggplot(aes(x = age, y = share)) +
  geom_col(width = .5) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), vjust = 1.2) +
  labs(x = NULL, y = NULL, title = "Respondents without an internet-enabled device, by age") +
  theme(axis.text.y = element_blank())
```

## Registered voter x age x gender

This is pretty typical nationwide.

```{r voter}
voter <- read %>% 
  select(registered_voter, gender, age = big_age_band) %>% 
  group_by(registered_voter, gender, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(gender_age_totals %>% mutate(registered_voter = "Total")) %>% 
  group_by(age, gender) %>% 
  calc_shares(group = registered_voter, denom = "Total", value = n) %>% 
  ungroup()

voter %>% 
  filter(!is.na(share), !is.na(age), registered_voter == "Yes", !is.na(gender), !gender %in% c("Transgender & NB", "Opt out"), !is.na(age)) %>% 
  ggplot(aes(x = age, y = share, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), vjust = 1.2) +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow")])) +
  labs(title = "Share of respondents who are registered to vote", x = NULL, y = NULL, caption = "Transgender & NB dropped due to low counts") +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom")
  
```

## Other demographic details

Unsurprisingly, half of the students are younger people, middle aged adults have kids under 18. Few business owners.

```{r person_type}
person_type <- read %>%
  select(person_type, age = big_age_band, gender) %>% 
  group_by(person_type, gender, age) %>% 
  count() %>% 
  ungroup() %>% 
  bind_rows(gender_age_totals %>% mutate(person_type = "Total")) %>% 
  group_by(age, gender) %>% 
  calc_shares(group = person_type, denom = "Total", value = n) %>% 
  ungroup()

person_type %>% 
  mutate(age = as.factor(age) %>% fct_rev()) %>% 
  filter(!is.na(share), !is.na(age), !is.na(gender), !gender %in% c("Transgender & NB", "Opt out"), person_type != "None of these") %>% 
  ggplot(aes(x = share, y = age, group = gender)) +
  geom_col(aes(fill = gender), width = .8, position = position_dodge(.9)) +
  geom_text(data = . %>% filter(share >= .11), aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), hjust = 1.2) +
  geom_text(data = . %>% filter(share < .11), aes(label = scales::percent(share, accuracy = 1)), position = position_dodge(.9), hjust = -.2, color = "black") +
  facet_grid(cols = vars(person_type)) +
  scale_fill_manual(values = unname(qual_pal[c("cyan", "yellow")])) +
  labs(title = "Share of respondents by person type and gender", x = NULL, y = NULL, caption = "Transgender & NB dropped due to low counts n < 10") +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom")
```


